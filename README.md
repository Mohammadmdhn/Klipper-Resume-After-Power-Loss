# Royal3DP-Klipper-PLR

Royal3DP-Klipper-PLR is an advanced Power Loss Recovery solution for **Klipper firmware**-based 3D printers. This project automates resuming a 3D print after a power outage by processing the G-code and extracting the exact restart position using the last recorded Z height.

## Project Status: Active Development
This project is under continuous development, testing, and enhancement. Users are encouraged to report any issues or suggest improvements through GitHub.

## Key Considerations Before Use
- **Manually Raise the Z-Axis:** After a power loss, manually lift the Z-axis before resuming the print to prevent nozzle collisions and print defects.
- **Accurate X/Y Homing:** Verify that X and Y axes home accurately to avoid misaligned layers during print recovery.

## Key Features
- Automatically detects the last recorded Z height from `variables.cfg`.
- Supports G-code generated by both **Cura** and **SuperSlicer/PrusaSlicer**.
- Extracts and resumes G-code starting from the identified Z height.
- Performs validation checks to minimize print resumption errors.
- Handles extruder position restoration based on slicer type.
- Includes easy-to-use installation and uninstallation scripts.

## Compatibility
Tested on:
- **MKS PI HSK**
- **Raspberry Pi with Klipper**

Default user paths are configured for the `mks` user. If you are using `pi` or any other user, you need to adjust the paths in the scripts accordingly.

## Prerequisites
- **Klipper firmware** installed on your 3D printer.
- **Linux environment** (Tested on MKS PI HSK and Raspberry Pi OS).
- `gcodeshellcommand` extension enabled in Klipper.
- G-code files with:
  - `;Z:` comments (for **SuperSlicer/PrusaSlicer**)
  - `LOG_Z` comments (for **Cura**)

## Installing `gcodeshellcommand` Extension
This extension is essential for executing shell commands from G-code.

### Installation Steps:
```bash
ssh mks@<IP_ADDRESS>
cd ~/klipper/
git clone https://github.com/th33xitus/gcodeshellcommand.git
```

Add the following to `moonraker.conf`:
```ini
[server]
allow_shell_commands: true
```

Restart Klipper and Moonraker:
```bash
sudo service klipper restart
sudo service moonraker restart
```

## Installation of Royal3DP-Klipper-PLR
Run the following command:
```bash
bash -c "$(curl -fsSL https://raw.githubusercontent.com/Mohammadmdhn/Royal3DP-Klipper-PLR/main/install.sh)"
```

This will:
- Copy the required configuration files to the appropriate directories.
- Modify `printer.cfg` and `moonraker.conf` to include the necessary configurations.
- Set executable permissions for shell scripts.

## Usage
After installation, if a power loss occurs:
1. Ensure Z-axis is manually raised to avoid nozzle collision.
2. Use the following command in your Klipper console:
```gcode
RESUME_INTERRUPTED
```
This will:
- Extract the remaining G-code from the last recorded Z height.
- Prepare the print environment (temperature, extruder position, etc.).
- Resume the print from the correct layer.

The processed G-code file will be saved in:
```
/home/mks/printer_data/gcodes/plr/<filename>.gcode
```

## Example Console Output
```
Detected Slicer Type: Cura
Resume Z Height from variables.cfg: 10.200
Cura Mode: Start printing from Z=10.200
Processing complete. Saved to: /home/mks/printer_data/gcodes/plr/<filename>.gcode
```

## Uninstallation
To remove Royal3DP-Klipper-PLR and its configurations:
```bash
bash -c "$(curl -fsSL https://raw.githubusercontent.com/Mohammadmdhn/Royal3DP-Klipper-PLR/main/uninstall.sh)"
```
This will:
- Remove `plr.cfg`, `gcode_shell_command.py`, `update_royal3d_plr.cfg`.
- Delete relevant entries from `printer.cfg` and `moonraker.conf`.
- Remove the `plr` folder under G-code directory.

## Troubleshooting and Validation
- Ensure Z-axis is physically raised after power loss before running `RESUME_INTERRUPTED`.
- Verify X and Y axes home correctly.
- Cura users: Add `LOG_Z` after every layer change.
- Check `variables.cfg` for correct height after each print.

## File Descriptions
- `plr.sh`: Core recovery script.
- `install.sh`: Installation script.
- `uninstall.sh`: Uninstallation script.
- `gcode_shell_command.py`: Enables shell commands from G-code.
- `clear_plr.sh`: Clears variables in `variables.cfg`.
- `plr.cfg`: Klipper macros for power loss recovery.

## License
This project is licensed under the MIT License.

## Acknowledgments
Inspired by and based on [YUMI_PLR](https://github.com/Yumi-Lab/YUMI_PLR).

## Author
- **Mohamad Madahiana**
- [royal3dp.ir](https://royal3dp.ir)
- [GitHub](https://github.com/Mohammadmdhn)
- [LinkedIn](https://www.linkedin.com/in/mohammad-madahian-5ab2b622a/)
- Contact: +98 9137817673

