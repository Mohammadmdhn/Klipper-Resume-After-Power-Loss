[force_move]
enable_force_move: True

[delayed_gcode KINEMATIC_POSITION]
initial_duration:0.2
gcode:
      SET_KINEMATIC_POSITION X=0
      SET_KINEMATIC_POSITION Y=0
      SET_KINEMATIC_POSITION Z=0

[respond]
default_type: echo

[gcode_macro G31]
gcode:
      RUN_SHELL_COMMAND CMD=clear_plr

[gcode_shell_command clear_plr]
command: sh /home/pi/YUMI_PLR/clear_plr.sh
timeout: 5.
[gcode_macro save_last_file]
gcode:

  {% set svv = printer.save_variables.variables %}

  {% set filepath=printer.virtual_sdcard.file_path %}

  {% set filename=filepath.split('/')%}

  SAVE_VARIABLE VARIABLE=last_file VALUE='"{ filename[-1] }"'
  SAVE_VARIABLE VARIABLE=filepath VALUE='"{ printer.virtual_sdcard.file_path }"'


  M118 Last File: { filename[-1] }

[gcode_macro clear_last_file]
gcode:
  {% set filename='' %}
  {% set filepath='' %}
  SAVE_VARIABLE VARIABLE=last_file VALUE='"{ filename }"'
  SAVE_VARIABLE VARIABLE=filepath VALUE='"{ filepath }"'
  
[gcode_shell_command POWER_LOSS_RESUME]
command: sh /home/pi/YUMI_PLR/plr.sh
timeout: 420.
[gcode_macro RESUME_INTERRUPTED]
gcode:
    # ğŸ”’ Ù‚ÙÙ„ Ú©Ø±Ø¯Ù† Ù…Ø­ÙˆØ± Z Ù‚Ø¨Ù„ Ø§Ø² Ù‡Ø± Ø­Ø±Ú©Øª
    {% set z_height = params.Z_HEIGHT|default(printer.save_variables.variables.power_resume_z)|float %}
    SET_KINEMATIC_POSITION Z={z_height}
    M220 S50
    G91
    G1 Z10 F600
    G90
    # ğŸ  Ø§Ø¬Ø±Ø§ÛŒ Ù‡ÙˆÙ… X, Y Ùˆ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§Ø¬Ø±Ø§ÛŒ Z_HOP
    G28 X Y

    # âœ… Ø¨Ù‡â€ŒØµÙˆØ±Øª Ø¯Ø³ØªÛŒ Z_HOP Ø±Ø§ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ Ø§Ø² Ø¹Ù…Ù„Ú©Ø±Ø¯ ØµØ­ÛŒØ­ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒÙ…
    G91  ; Ø­Ø±Ú©Øª Ù†Ø³Ø¨ÛŒ
    G1 Z-10 F600  ; Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Z Ø¨Ù‡ Ù…Ù‚Ø¯Ø§Ø± Ù‚Ø¨Ù„ÛŒ
    G90  ; Ø­Ø±Ú©Øª Ù…Ø·Ù„Ù‚

    # âœ… ØªÙ†Ø¸ÛŒÙ… Ù…Ù‚Ø¯Ø§Ø± Z Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Ù¾Ø±ÛŒÙ†Øª
    SET_KINEMATIC_POSITION Z={z_height}

    # ğŸ”„ ØªÙ†Ø¸ÛŒÙ… Ø§Ú©Ø³ØªØ±ÙˆØ¯Ø± Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù…Ø´Ú©Ù„Ø§Øª Ø§Ú©Ø³ØªØ±ÙˆÚ˜Ù†
    G92 E0
    G1 E0.5 F300  ; Ø§Ú©Ø³ØªØ±ÙˆØ¯ Û°.Ûµ Ù…ÛŒÙ„ÛŒÙ…ØªØ± ÙÛŒÙ„Ø§Ù…Ù†Øª Ø¨Ø±Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù†Ø§Ø²Ù„

    # ğŸ—ï¸ Ø§Ø¬Ø±Ø§ÛŒ `POWER_LOSS_RESUME`
    RUN_SHELL_COMMAND CMD=POWER_LOSS_RESUME PARAMS="{z_height} \"{printer.save_variables.variables.last_file}\""

    # ğŸ–¨ï¸ Ø§Ø¬Ø±Ø§ÛŒ Ù¾Ø±ÛŒÙ†Øª Ø§Ø² G-code Ù¾Ø±Ø¯Ø§Ø²Ø´â€ŒØ´Ø¯Ù‡
    SDCARD_PRINT_FILE FILENAME=plr/"{printer.save_variables.variables.last_file}"

#[gcode_macro RESUME_INTERRUPTED]
#gcode:
    # ğŸ”’ Ù‚ÙÙ„ Ú©Ø±Ø¯Ù† Ù…Ø­ÙˆØ± Z Ù‚Ø¨Ù„ Ø§Ø² Ù‡Ø± Ø­Ø±Ú©Øª
#    {% set z_height = params.Z_HEIGHT|default(printer.save_variables.variables.power_resume_z)|float %}
 #   SET_KINEMATIC_POSITION Z={z_height}

  #  # ğŸ  Ù‡ÙˆÙ… Ú©Ø±Ø¯Ù† ÙÙ‚Ø· X, Y Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Z
   # G28 X Y

    # âœ… Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ†Ø¸ÛŒÙ… Ù…Ù‚Ø¯Ø§Ø± Z Ø¨Ø¹Ø¯ Ø§Ø² Ù‡ÙˆÙ… Ú©Ø±Ø¯Ù†
    #SET_KINEMATIC_POSITION Z={z_height}

    # ğŸ”„ ØªÙ†Ø¸ÛŒÙ… Ø§Ú©Ø³ØªØ±ÙˆØ¯Ø±
    #G92 E0
    #G1 E0.5 F300  ; Ø§Ú©Ø³ØªØ±ÙˆØ¯ Û°.Ûµ Ù…ÛŒÙ„ÛŒÙ…ØªØ± Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù…Ø´Ú©Ù„Ø§Øª Ø§Ú©Ø³ØªØ±ÙˆÚ˜Ù†
    #M220 S20
    # ğŸ—ï¸ Ø§Ø¬Ø±Ø§ÛŒ `POWER_LOSS_RESUME`
    #RUN_SHELL_COMMAND CMD=POWER_LOSS_RESUME PARAMS="{z_height} \"{printer.save_variables.variables.last_file}\""

    # ğŸ–¨ï¸ Ø§Ø¬Ø±Ø§ÛŒ Ù¾Ø±ÛŒÙ†Øª Ø§Ø² G-code Ù¾Ø±Ø¯Ø§Ø²Ø´â€ŒØ´Ø¯Ù‡
    #SDCARD_PRINT_FILE FILENAME=plr/"{printer.save_variables.variables.last_file}"

[gcode_macro LOG_Z]
gcode:
    {% set z_pos = printer.gcode_move.gcode_position.z %}
    RESPOND MSG="Current Z is {z_pos}"
    SAVE_VARIABLE VARIABLE=power_resume_z VALUE={z_pos}
[save_variables]
filename =/home/pi/printer_data/config/variables.cfg